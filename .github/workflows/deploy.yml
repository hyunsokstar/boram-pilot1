name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # CI ë‹¨ê³„: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Lint check
        run: npm run lint

      - name: Build application
        run: npm run build

      - name: Run tests (if available)
        run: npm test --if-present

  # CD ë‹¨ê³„: í”„ë¡œë•ì…˜ ë°°í¬
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            # Node.js í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v node >/dev/null 2>&1; then
              echo "ğŸ“¥ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            else
              echo "âœ… Node.js: $(node --version)"
            fi

            # PM2 í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "ğŸ“¥ Installing PM2..."
              sudo npm install -g pm2
            else
              echo "âœ… PM2: $(pm2 -v)"
            fi

            PROJECT_PATH="/home/ubuntu/boram-pilot1"
            cd "$PROJECT_PATH"

            # EACCES ë°©ì§€ë¥¼ ìœ„í•´ ì†Œìœ ê¶Œ ì •ë¦¬ (ê³¼ê±° sudoë¡œ ìƒì„±ëœ íŒŒì¼ ì •ë¦¬)
            echo "ğŸ” Fixing ownership..."
            sudo chown -R $USER:$USER .

            echo "ğŸ“¥ Pulling latest changes..."
            git fetch --all --prune
            git reset --hard origin/main
            git clean -fd

            echo "ğŸ“¦ Installing dependencies..."
            rm -rf node_modules
            npm ci --omit=dev --no-audit --no-fund

            echo "ğŸ”¨ Building application (production)..."
            npm run build:production

            echo "ğŸ”„ Restarting application via PM2..."
            pm2 restart boram-pilot1 || pm2 start ecosystem.config.js
            pm2 save

            echo "ğŸ¥ Health check..."
            sleep 10
            curl -f http://localhost:3000/api/health || echo "Health check failed"

            echo "ğŸ‰ Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment succeeded!"
          else
            echo "âŒ Deployment failed!"
          fi
